#!/usr/bin/env node

var app      = require('http').createServer(handler),
    fs       = require('fs'),
    Grapher  = require('../lib/grapher.js'),
    _        = require('underscore')._;

function handler(req, res) {
  var rtn = [], grapher;

  // if the request if for a favicon, ignore it.
  if (req.url === '/favicon.ico') {
    res.end();
    return;
  }

  // if the root is requested then display instructions.
  if (req.url === '/') {
    res.writeHead(200, {'Content-Type': 'text/html'});
    fs.readFile(__dirname + '/../static/index.html', function (err, page) {
      if (err) throw err;
      res.end(page);
    });
    return;
  }

  // get the query object
  var query = require('url').parse(req.url, true).query;

  if (_.isEmpty(query)) {
    grapher = Grapher.graph('http:/' + req.url, {strict:true});
  } else {
    grapher = Grapher.graphFromQuery(query);
  }

  grapher.then(function(graph) {
    res.writeHead(200, {'Content-Type': 'application/json; charset=utf-8'});
    res.end(graph.toJSONP(query.callback));
  });
}

app.listen(8888, 'localhost');

console.log('App @ http://localhost:8888');