#!/usr/bin/env node

var app     = require('http').createServer(handler),
    fs      = require('fs'),
    Grapher = require('../lib/grapher.js'),
    cache   = require('../lib/cache.js'),
    fn      = require('../lib/functions.js'),
    _       = require('underscore')._;

function handler(req, res) {
  var rtn = [], grapher, cacheKey, queryUrl, options;

  // if the request if for a favicon, ignore it.
  if (req.url === '/favicon.ico') {
    res.end();
    return;
  }

  // if the root is requested then display instructions.
  if (req.url === '/') {
    res.writeHead(200, {'Content-Type': 'text/html'});
    fs.readFile(__dirname + '/../static/index.html', function (err, page) {
      if (err) throw err;
      res.end(page);
    });
    return;
  }

  // build the url that socialgraph will query against
  var query = require('url').parse(req.url, true).query;

  if (_.isEmpty(query)) {
    queryUrl = normalizeUrl(req.url.substring(1));
  } else {
    if (query.url) {
      queryUrl = normalizeUrl(query.url);
    } else {
      res.writeHead(400, {'Content-Type': 'application/json; charset=utf-8'});
      var error = JSON.stringify({
        errors: "'url' is a required parameter"
      });
      error = query.callback ? query.callback + '(' + error + ');' : error;
      res.end(error);
      return;
    }
  }

  // build the options object
  options = {}
  if (query.strict !== undefined) {
    options.strict = query.strict;
  } else {
    options.strict = false;
  }

  console.log(query.strict, options.strict);

  // build the object that the cache will cache against
  cacheKey = 'graph;';
  cacheKey += options.strict ? 'strict;' : '';
  cacheKey += queryUrl;

  if (cache.has(cacheKey)) {
    cache.fetch(cacheKey, function (errors, jsonGraph) {
      respond(res, jsonGraph, query.callback);
      console.log('from cache   : ' + queryUrl);
    });
  } else {
    grapher = Grapher.graph(queryUrl, options);

    grapher.then(function(graph) {
      var json = graph.toJSON();
      cache.set(cacheKey, json);
      respond(res, json, query.callback);
    });
  }
}

function respond (res, json, callback) {
  res.writeHead(200, {'Content-Type': 'application/json; charset=utf-8'});
  if (callback) {
    res.end(callback + '(' + json + ');');
  } else {
    res.end(json);
  }
}

function normalizeUrl (url) {
  var urlBits = require('url').parse(url, true),
      url     = fn.url.removeTrailingSlash(urlBits.href);

  return urlBits.protocol ? url : "http://" + url;
}

app.listen(8888, 'localhost');

console.log('App @ http://localhost:8888');